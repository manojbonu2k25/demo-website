name: HTML Static Site Deploy with Backup

on:
  push:
    branches: [master]

jobs:
  deploy-static-site:
    runs-on: self-hosted

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Create timestamp for backup
      shell: pwsh
      run: |
        $ts = Get-Date -Format 'yyyyMMdd_HHmmss'
        echo "TIMESTAMP=$ts" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

        - name: Backup current deployed site
        shell: pwsh
        run: |
          $deployPath = "C:\inetpub\wwwroot\YourApp"
          $backupPath = "C:\Users\manoj\Deployments\backup\backup_$env:TIMESTAMP"
      
          if (Test-Path $deployPath) {
            New-Item -Path $backupPath -ItemType Directory -Force | Out-Null
            Copy-Item -Path "$deployPath\*" -Destination $backupPath -Recurse
            Write-Host "Backup completed to $backupPath"
          } else {
            Write-Host "No existing deployment to back up."
          }
      

    - name: Deploy new static files to IIS
      shell: cmd
      run: >
        rmdir /s /q "C:\inetpub\wwwroot\YourApp" &&
        mkdir "C:\inetpub\wwwroot\YourApp" &&
        xcopy ".\*" "C:\inetpub\wwwroot\YourApp\" /s /e /y /i
